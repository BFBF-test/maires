name: Mise à jour quotidienne des articles Maire-Info

on:
  schedule:
    - cron: '0 7 * * 1-5'
    - cron: '0 13 * * 1-5'
    - cron: '0 19 * * 1-5'
    - cron: '0 19 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-articles:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du dépôt
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Récupération et traitement des articles
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const http = require('http');
            const fs = require('fs');

            const RSS_URL = 'http://www.maire-info.com/rss/';
            const MAX_ARTICLES = 500;

            function fetchUrl(url) {
              return new Promise((resolve, reject) => {
                const client = url.startsWith('https') ? https : http;
                client.get(url, {
                  headers: { 'User-Agent': 'MaireInfoArchiver/1.0' },
                  timeout: 15000
                }, (res) => {
                  if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
                    return fetchUrl(res.headers.location).then(resolve).catch(reject);
                  }
                  let data = '';
                  res.setEncoding('utf8');
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve(data));
                  res.on('error', reject);
                }).on('error', reject);
              });
            }

            function decodeHtmlEntities(str) {
              return str
                .replace(/&rsquo;/g, '\u2019').replace(/&laquo;/g, '\u00AB').replace(/&raquo;/g, '\u00BB')
                .replace(/&eacute;/g, 'é').replace(/&egrave;/g, 'è').replace(/&agrave;/g, 'à')
                .replace(/&ugrave;/g, 'ù').replace(/&ecirc;/g, 'ê').replace(/&ocirc;/g, 'ô')
                .replace(/&icirc;/g, 'î').replace(/&ucirc;/g, 'û').replace(/&acirc;/g, 'â')
                .replace(/&euml;/g, 'ë').replace(/&iuml;/g, 'ï').replace(/&ouml;/g, 'ö')
                .replace(/&uuml;/g, 'ü').replace(/&ccedil;/g, 'ç')
                .replace(/&Eacute;/g, 'É').replace(/&Egrave;/g, 'È').replace(/&Agrave;/g, 'À')
                .replace(/&Ecirc;/g, 'Ê').replace(/&Ocirc;/g, 'Ô')
                .replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"').replace(/&#0?39;/g, "'").replace(/&nbsp;/g, ' ')
                .replace(/&ndash;/g, '\u2013').replace(/&mdash;/g, '\u2014').replace(/&hellip;/g, '\u2026')
                .replace(/&oelig;/g, '\u0153').replace(/&OElig;/g, '\u0152');
            }

            function stripCDATA(str) { return str.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g, '$1'); }
            function stripHtml(str) { return str.replace(/<[^>]+>/g, '').trim(); }

            function extractTag(xml, tag) {
              const regex = new RegExp('<' + tag + '[^>]*>([\\s\\S]*?)</' + tag + '>', 'i');
              const match = xml.match(regex);
              return match ? match[1].trim() : '';
            }

            function extractIdFromUrl(url) {
              const match = url.match(/param=(\d+)/);
              return match ? parseInt(match[1]) : 0;
            }

            function isoDate(pubDate) {
              try {
                const d = new Date(pubDate);
                return isNaN(d.getTime()) ? new Date().toISOString().slice(0, 10) : d.toISOString().slice(0, 10);
              } catch(e) { return new Date().toISOString().slice(0, 10); }
            }

            function parseRSS(xml) {
              const items = [];
              const itemRegex = /<item>([\s\S]*?)<\/item>/gi;
              let match;
              while ((match = itemRegex.exec(xml)) !== null) {
                const itemXml = match[1];
                const title = decodeHtmlEntities(stripCDATA(extractTag(itemXml, 'title')));
                const link = extractTag(itemXml, 'link').trim();
                const descRaw = stripCDATA(extractTag(itemXml, 'description'));
                const description = decodeHtmlEntities(stripHtml(descRaw)).replace(/\s+/g, ' ').trim();
                const pubDate = extractTag(itemXml, 'pubDate');
                if (title && link) {
                  items.push({
                    id: extractIdFromUrl(link),
                    title: title,
                    description: description.slice(0, 500),
                    url: link,
                    date: isoDate(pubDate),
                    rubrique: ''
                  });
                }
              }
              return items;
            }

            async function fetchRubrique(articleUrl) {
              try {
                const html = await fetchUrl(articleUrl);
                const rubriqueMatch = html.match(/refer=listerubriques[^"]*"[^>]*>([^<]+)/i);
                if (rubriqueMatch) return decodeHtmlEntities(rubriqueMatch[1].trim());
                return '';
              } catch(e) { return ''; }
            }

            console.log('Recuperation du flux RSS...');
            let rssXml;
            try {
              rssXml = await fetchUrl(RSS_URL);
              console.log('Flux RSS recupere (' + rssXml.length + ' car.)');
            } catch(e) {
              core.setFailed('Erreur RSS : ' + e.message);
              return;
            }

            const newArticles = parseRSS(rssXml);
            console.log(newArticles.length + ' article(s) dans le RSS');

            if (newArticles.length === 0) {
              console.log('Aucun article dans le RSS.');
              return;
            }

            console.log('Recuperation des rubriques...');
            for (const article of newArticles) {
              article.rubrique = await fetchRubrique(article.url);
              console.log('  ' + article.title.slice(0, 60) + ' -> ' + (article.rubrique || '?'));
              await new Promise(r => setTimeout(r, 500));
            }

            let existingArticles = [];
            try {
              const html = fs.readFileSync('index.html', 'utf-8');
              const m = html.match(/const ARTICLES = (\[[\s\S]*?\]);/);
              if (m) existingArticles = JSON.parse(m[1]);
              console.log(existingArticles.length + ' article(s) en archives');
            } catch(e) { console.log('Creation initiale.'); }

            const existingIds = new Set(existingArticles.map(a => a.id));
            let added = 0;
            for (const a of newArticles) {
              if (!existingIds.has(a.id)) {
                existingArticles.push(a);
                existingIds.add(a.id);
                added++;
              }
            }
            console.log(added + ' nouvel(aux) article(s)');

            existingArticles.sort((a, b) => {
              if (a.date !== b.date) return b.date.localeCompare(a.date);
              return b.id - a.id;
            });
            if (existingArticles.length > MAX_ARTICLES) {
              existingArticles = existingArticles.slice(0, MAX_ARTICLES);
            }

            // Toujours mettre à jour le timestamp du dernier scan
            let indexHtml = fs.readFileSync('index.html', 'utf-8');
            const now = new Date().toISOString();
            indexHtml = indexHtml.replace(
              /const LAST_UPDATE = "[^"]*";/,
              'const LAST_UPDATE = "' + now + '";'
            );

            if (added > 0) {
              // Mettre à jour les articles seulement si nouveautés
              indexHtml = indexHtml.replace(
                /const ARTICLES = \[[\s\S]*?\];/,
                'const ARTICLES = ' + JSON.stringify(existingArticles, null, 2) + ';'
              );
              console.log(added + ' nouvel(aux) article(s) ajoute(s), total : ' + existingArticles.length);
            } else {
              console.log('Pas de nouvel article.');
            }

            fs.writeFileSync('index.html', indexHtml, 'utf-8');
            console.log('Dernier scan : ' + now);

      - name: Commit et push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --staged --quiet; then
            echo "Aucune modification."
          else
            ARTICLES_COUNT=$(grep -o '"id"' index.html | wc -l)
            DATE=$(TZ='Europe/Paris' date +%Y-%m-%d)
            HOUR=$(TZ='Europe/Paris' date +%Hh%M)
            git commit -m "maj $DATE $HOUR - $ARTICLES_COUNT articles"
            git push
          fi
